// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.
//>>built
define("esri/plugins/FeatureLayerStatistics","dojo/_base/lang dojo/_base/array dojo/_base/declare dojo/has dojo/Deferred dojo/on dojo/promise/all dojo/when dojo/string ../kernel ../config ../urlUtils ../Evented ../SpatialReference ../renderers/arcadeUtils ../tasks/query ../tasks/StatisticDefinition ../tasks/GenerateRendererTask ../tasks/UniqueValueDefinition ../tasks/ClassBreaksDefinition ../tasks/GenerateRendererParameters ../tasks/generateRenderer ../tasks/GeometryService ../tasks/ProjectParameters ../layers/TileInfo ../layers/HeatmapManager ../workers/heatmapCalculator ../geometry/mathUtils ../geometry/webMercatorUtils ../geometry/scaleUtils ../geometry/Point ../geometry/Extent".split(" "),
function(r,n,I,J,q,F,K,w,L,M,B,N,O,A,u,v,C,P,Q,R,D,S,T,U,V,W,G,E,H,X,Y,Z){B=B.defaults;var $=G.prototype._calculateIntensityMatrix,aa=G.calculateStats,ba=W.prototype._getScreenPoints,ca=/_value$/i,z=I([O],{declaredClass:"esri.plugins.FeatureLayerStatistics",sampleSize:500,worldScale:1E8,generalizeForScale:4E5,generalizeForResolution:105,mapWidth:1280,mapHeight:800,mapPaddingRatioForFE:0.25,minDistance:12,minLength:30,minSize:15,minScaleRelaxationRatio:0.25,samplingThreshold:2E4,numBins:10,numClasses:5,
classificationMethod:"equal-interval",standardDeviationInterval:1,geometryServiceUrl:N.getProtocolForWebResource()+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",tileInfo:new V({rows:256,cols:256,dpi:96,format:"JPEG",compressionQuality:90,origin:{x:-2.0037508342787E7,y:2.0037508342787E7},spatialReference:{wkid:102100,latestWkid:3857},lods:[{level:0,resolution:156543.03392800014,scale:5.91657527591555E8},{level:1,resolution:78271.51696399994,scale:2.95828763795777E8},{level:2,
resolution:39135.75848200009,scale:1.47914381897889E8},{level:3,resolution:19567.87924099992,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},{level:9,resolution:305.74811314055756,scale:1155581.108577},{level:10,resolution:152.87405657041106,
scale:577790.554289},{level:11,resolution:76.43702828507324,scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,scale:4513.988705},{level:18,resolution:0.5971642835598172,scale:2256.994353},{level:19,
resolution:0.29858214164761665,scale:1128.497176}]}),_outlineInfo:[{size:10,width:0},{size:20,width:0.5},{size:80,width:1},{size:250,width:2}],constructor:function(a){r.mixin(this,a);this._scaleCache=this._sampleCache=null;this._gsTask=B.geometryService||new T(this.geometryServiceUrl);if(this.layer.loaded)this._createGRTask();else F.once(this.layer,"load",r.hitch(this,this._createGRTask))},destroy:function(){this.layer=this._grTask=this._scaleCache=this._sampleCache=null},getUniqueValues:function(a){var b=
new q;!a||!a.field&&!a.sqlExpression?this._rejectDfd(b,"FeatureLayerStatistics.getUniqueValues: 'field' or 'sqlExpression' parameter is required."):this._callAfterLoad(this._findUniqueValues,{dfd:b,params:a});return b.promise},getPredominantCategories:function(a){var b=new q;!a||!a.fields?this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: 'fields' parameter is missing."):2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: invalid fields. Minimum required is 2."):
this._callAfterLoad(this._predominantCategories,{dfd:b,params:a});return b.promise},getPredominanceExpressions:function(a){var b=new q;!a||!a.fields?this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: 'fields' parameter is missing."):2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominanceExpressions,{dfd:b,params:a});return b.promise},getAgeStatistics:function(a){var b=
new q;null==a.startTime||null==a.endTime||null==a.units?this._rejectDfd(b,"FeatureLayerStatistics.getAgeStatistics: 'startTime', 'endTime' or 'units' parameter is missing."):this._callAfterLoad(this._ageStatistics,{dfd:b,params:a});return b.promise},getSuggestedAgeUnits:function(a){var b=new q;null==a.startTime||null==a.endTime?this._rejectDfd(b,"FeatureLayerStatistics.getSuggestedAgeUnits: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._suggestedAgeUnits,{dfd:b,params:a});
return b.promise},getAgeExpressions:function(a){var b=new q;null==a.startTime||null==a.endTime?this._rejectDfd(b,"FeatureLayerStatistics.getAgeExpressions: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._ageExpressions,{dfd:b,params:a});return b.promise},getFieldStatistics:function(a){var b=new q;!a||!a.field&&!a.valueExpression&&!a.sqlExpression?this._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: 'field', 'valueExpression' or 'sqlExpression' parameter is required."):
this._callAfterLoad(this._getFieldStats,{dfd:b,params:a});return b.promise},getSuggestedDataRange:function(a){var b=a&&a.statistics;if(b){var c,d;null==b.min?a.isDate?(a=this._getYearOfDate(),c=a[0],d=a[1]):(c=0,d=100):b.min===b.max&&(a.isDate?(a=this._getYearOfDate(b.min),c=a[0],d=a[1]):0>b.min?(c=2*b.min,d=0):0<b.min?(c=0,d=2*b.min):(c=0,d=100));return{min:null!=c?c:b.min,max:null!=d?d:b.max,defaultStatistics:null!=c||null!=d}}console.log("FeatureLayerStatistics.getSuggestedDataRange: 'statistics' parameter is required.")},
getSpatialStatistics:function(a){var b=new q;!a||!a.features||!a.features.length?this._rejectDfd(b,"FeatureLayerStatistics.getSpatialStatistics: 'features' parameter is missing or it has no features."):this._callAfterLoad(this._spatialStats,{dfd:b,params:a});return b.promise},getSuggestedSizeRange:function(a){var b=new q;this._callAfterLoad(this._getSizeRange,{dfd:b,params:a});return b.promise},getSuggestedOutline:function(a){var b=new q;this._callAfterLoad(this._getOutline,{dfd:b,params:a});return b.promise},
getHeatmapStatistics:function(a){var b=new q;this._callAfterLoad(this._getHeatmapStats,{dfd:b,params:a});return b.promise},getHistogram:function(a){var b=new q;!a||!a.field&&!a.valueExpression&&!a.sqlExpression?this._rejectDfd(b,"FeatureLayerStatistics.getHistogram: 'field', 'valueExpression' or 'sqlExpression' parameter is required."):this._callAfterLoad(this._getHistogram,{dfd:b,params:a});return b.promise},getSampleFeatures:function(a){var b=new q;this._callAfterLoad(this._sampleFeatures,{dfd:b,
params:a});return b.promise},getSuggestedScaleRange:function(a){var b=new q;this._callAfterLoad(this._scaleRange,{dfd:b,params:a});return b.promise},getClassBreaks:function(a){var b=new q;!a||!a.field?this._rejectDfd(b,"FeatureLayerStatistics.getClassBreaks: 'field' parameter is missing."):this._callAfterLoad(this._findClassBreaks,{dfd:b,params:a});return b.promise},_srcQuery:"service-query",_srcGenRend:"service-generate-renderer",_srcMemory:"features-in-memory",_srcFeatures:"features",_log10e:Math.LOG10E,
_reNumber:/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,_isCollection:function(){return!this.layer.url},_getFieldStats:function(a){var b=this,c=a.params,d=r.isFunction(c.field),e=c.valueExpression||c.sqlExpression,f=c.field&&!d?this.layer.getField(c.field):null,g=f?f.type===this._dateType:!1;if(f){if(this._rejectIfInvalidType(a.dfd,f,"getFieldStatistics",[].concat(this._numericTypes).concat(this._dateType)))return;if(g&&c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when calculating statistics for date field.");
return}}else if(e&&c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when valueExpression or sqlExpression is specified.");return}!this._isCollection()&&!c.features&&!d?!this._canUseSQL92Expression()&&(g||e)?this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate statistics. Make sure the layer supports SQL expressions and standardized queries."):(c.normalizationType?this._statsFromGenRend(c):this._statsFromQuery(c,
g)).then(function(c){b._resolveStats(a.dfd,c)}).otherwise(function(d){b._statsFromMemory(c,g).then(function(c){b._resolveStats(a.dfd,c)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})}):this._statsFromMemory(c,g).then(function(c){b._resolveStats(a.dfd,c)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})},_resolveStats:function(a,b){a.resolve(b)},
_statsFromQuery:function(a,b){var c;this._canUseSQL92Expression()&&b&&(c=r.mixin({},a),delete c.field,c.sqlExpression=this._msSinceUnixEpochSQL(a.field));return this._executeStatsQuery(c||a).then(function(a){b&&(n.forEach("min max avg stddev sum variance".split(" "),function(b){null!=a[b]&&(a[b]=Math.ceil(a[b]))}),a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0));return a})},_msSinceUnixEpochSQL:function(a){return this._getDateDiffSQL(new Date(0),a,"milliseconds").sqlExpression},_executeStatsQuery:function(a){var b=
this.layer,c=new q;if(b.url&&b.supportsStatistics){var d=new v,e=this,f=a.sqlExpression||a.field,g=f?this._getRangeExpr(f,a.minValue,a.maxValue):null;d.sqlFormat=a.sqlExpression?"standard":null;d.where=this._mergeWhereClauses(a.sqlWhere,g);d.outStatistics=n.map("min max avg stddev count sum var".split(" "),function(a){var b=new C;b.statisticType=a;b.onStatisticField=f;b.outStatisticFieldName=("var"===a?"variance":a)+"_value";return b});b.queryFeatures(d).then(function(a){a=(a=a&&a.features)&&a[0]&&
a[0].attributes;var b,d={source:e._srcQuery};for(b in a)d[b.replace(ca,"").toLowerCase()]=a[b];d.min===d.max&&(null!=d.min&&null==d.stddev)&&(d.stddev=d.variance=0);c.resolve(d)}).otherwise(function(a){e._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return c.promise},_mergeWhereClauses:function(a,b){var c=a;b&&(c=c?"("+c+") AND ("+b+")":b);return c},_statsFromMemory:function(a,
b){var c=new q,d;if("percent-of-total"===a.normalizationType){d=this._calcStatsFromMemory({field:a.field}).sum;if(null==d){this._rejectDfd(c,"getFieldStatistics: invalid normalizationTotal.");return}a=r.mixin({normalizationTotal:d},a)}c.resolve(this._calcStatsFromMemory(a,b));return c.promise},_calcStatsFromMemory:function(a,b){var c=!(!a.features||!a.features.length),d=this._getDataValues(c?a.features:this.layer.graphics,a),e=this._calcStatistics(d,!a.normalizationType);e.source=c?this._srcFeatures:
this._srcMemory;b&&n.forEach(["avg","stddev","variance"],function(a){null!=e[a]&&(e[a]=Math.ceil(e[a]))});return e},_getDataValues:function(a,b){var c=b.field,d=r.isFunction(c),e=b.valueExpression,f=b.normalizationType,g=b.normalizationField,h=b.normalizationTotal,k=null==b.minValue?-Infinity:b.minValue,l=null==b.maxValue?Infinity:b.maxValue,m,p,s,y=[];e&&(e=u.parseExpression(e));n.forEach(a,function(a){m=a.attributes;e?s=u.executeExpression(e,u.createExecContext(a)):d?s=c.call(null,a):m&&(s=m[c]);
f&&null!=s&&(p=m&&parseFloat(m[g]),"log"===f&&0!=s?s=Math.log(s)*this._log10e:"percent-of-total"===f&&!isNaN(h)&&0!=h?s=100*(s/h):"field"===f&&(!isNaN(p)&&0!=p)&&(s/=p));null!=s&&(!isNaN(s)&&s>=k&&s<=l)&&y.push(s)},this);return y},_calcStatistics:function(a,b){var c=Infinity,d=-Infinity,e=0,f=null,g=null,h=null,k=null;n.forEach(a,function(a){e++;f+=a;a<c&&(c=a);a>d&&(d=a)});if(e){var g=f/e,l=0;n.forEach(a,function(a){l+=Math.pow(a-g,2)});k=b?1<e?l/(e-1):0:0<e?l/e:0;h=Math.sqrt(k)}return{min:e?c:null,
max:e?d:null,count:e,sum:f,avg:g,stddev:h,variance:k}},_statsFromGenRend:function(a){var b=new q,c=this,d=a.normalizationType,e=a.normalizationField;this.getClassBreaks({field:a.field,classificationMethod:"standard-deviation",standardDeviationInterval:0.25,normalizationType:d,normalizationField:"field"===d?e:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var d,e,k;n.some(a.classBreakInfos,function(a,b){a.hasAvg&&(d=a);return!!d});d&&(k=d.maxValue-d.minValue,e=d.minValue+k/2,k*=
4);b.resolve({min:a.minValue,max:a.maxValue,avg:e,stddev:k,source:c._srcGenRend})}).otherwise(function(a){c._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: unable to calculate class breaks.")});return b.promise},_getYearOfDate:function(a){var b=("number"===typeof a?new Date(a):new Date).getUTCFullYear(),c=Date.UTC(b,0,1,12,0,0,0),b=Date.UTC(b,11,31,12,0,0,0);"number"===typeof a&&(a<c&&(c=a),a>b&&(b=a));return[c,b]},_spatialStats:function(a){var b=a.params.features,c=this.layer.geometryType,
d={},c={point:"esriGeometryPoint"===c,mPoint:"esriGeometryMultipoint"===c,line:"esriGeometryPolyline"===c,polygon:"esriGeometryPolygon"===c};c.point?d=this._getPointStats(b):c.mPoint?d=this._getPointStats(b,!0):c.line?d=this._getLineStats(b):c.polygon&&(d=this._getPolygonStats(b));d.avgXY=this._getAvgXY(b,c);a.dfd.resolve(d)},_getPointStats:function(a,b){var c,d,e=a.length,f,g,h={},k={},l=0,m=0,p=Infinity,s=-Infinity,n=0,t=0,x,q,r=[];if(b)for(c=0;c<e;c++)a[c].geometry&&r.push.apply(r,a[c].geometry.points);
else r=a;e=r.length;for(c=0;c<e;c++)if(b?(h.x=r[c][0],h.y=r[c][1],f=h):f=r[c].geometry,f){x=Infinity;q=-Infinity;for(d=0;d<e;d++)d!==c&&(b?(k.x=r[d][0],k.y=r[d][1],g=k):g=r[d].geometry,g&&(g=E.getLength(f,g),0<g&&(g<x&&(x=g),g<p&&(p=g),g>q&&(q=g),g>s&&(s=g))));Infinity!==x&&(++n,l+=x);-Infinity!==q&&(++t,m+=q)}return{minDistance:Infinity!==p?p:null,maxDistance:-Infinity!==s?s:null,avgMinDistance:n?l/n:null,avgMaxDistance:t?m/t:null}},_getLineStats:function(a){var b,c=a.length,d,e={},f={},g=Infinity,
h=-Infinity,k=0,l=0;for(b=0;b<c;b++)if(d=a[b].geometry)d=this._getLineLength(d,e,f),0<d&&(++l,k+=d,d<g&&(g=d),d>h&&(h=d));return{minLength:Infinity!==g?g:null,maxLength:-Infinity!==h?h:null,avgLength:l?k/l:null}},_getLineLength:function(a,b,c){a=a.paths;var d,e=a.length,f,g=0;for(d=0;d<e;d++)f=a[d],f=this._getActualLineLength(f,b,c),0<f&&(g+=f);return g},_getApproxLineLength:function(a,b,c){var d=a[0],e=a[a.length-1],f=0;d&&(e&&d[0]===e[0]&&d[1]===e[1])&&(e=a[a.length-2]);d&&(e&&d!==e)&&(b.x=d[0],
b.y=d[1],c.x=e[0],c.y=e[1],f=E.getLength(b,c));return f},_getActualLineLength:function(a,b,c){var d,e=a.length,f,g,h=0;for(d=0;d<e-1;d++)f=a[d],g=a[d+1],f&&g&&(b.x=f[0],b.y=f[1],c.x=g[0],c.y=g[1],h+=E.getLength(b,c));return h},_getPolygonStats:function(a){var b,c=a.length,d,e=Infinity,f=-Infinity,g=0,h=0;for(b=0;b<c;b++)if(a[b].geometry&&(d=a[b].geometry.getExtent()))d=(d.getWidth()+d.getHeight())/2,0<d&&(++h,g+=d,d<e&&(e=d),d>f&&(f=d));return{minSize:Infinity!==e?e:null,maxSize:-Infinity!==f?f:null,
avgSize:h?g/h:null}},_getAvgXY:function(a,b){var c,d,e,f=a.length,g,h,k,l,m=null,p=null,s=0,n;for(c=0;c<f;c++)if(d=a[c].geometry)if(b.point)++s,m+=d.x,p+=d.y;else if(b.mPoint){k=d.points;h=k.length;for(d=0;d<h;d++)++s,m+=k[d][0],p+=k[d][1]}else if(b.line){l=d.paths;g=l.length;for(d=0;d<g;d++){k=l[d];h=k.length;for(e=0;e<h;e++)++s,m+=k[e][0],p+=k[e][1]}}else if(b.polygon){l=d.rings;g=l.length;for(d=0;d<g;d++){k=l[d];h=k.length;for(e=0;e<h;e++)++s,m+=k[e][0],p+=k[e][1]}}null!=m&&null!=p&&(n={x:m/s,
y:p/s});return n},_getSizeRange:function(a){var b=this,c=a.params,d=this.layer,e=d.getMap();if("esriGeometryPolygon"!==d.geometryType)this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: not supported for points and lines.");else if(e)if(c&&"visible-scale-range"===c.optimizeForScale){var f=this._projectExtent(d.fullExtent,this.tileInfo.spatialReference);this.getSuggestedScaleRange({map:!1}).then(function(c){b._processSizeRange(c.spatialStatistics,e,a.dfd,f,c)}).otherwise(function(c){b._rejectDfd(a.dfd,
"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate suggested scale range.")})}else this._getFeatures(e,c).then(function(c){b.getSpatialStatistics({features:c}).then(function(c){b._processSizeRange(c,e,a.dfd)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate spatial statistics.")})}).otherwise(function(c){b._rejectDfd(a.dfd,c.message)});else this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: layer has to be added to the map.")},
_processSizeRange:function(a,b,c,d,e){var f=this;w(d).always(function(d){d=d&&d.hasOwnProperty("xmin")?d:null;f._calcSizeRange(a,b,c,d,e)})},_getFeatures:function(a,b){var c=new q,d=this,e;b&&b.useMapExtent?(e=new v,e.geometry=a.extent,e=this.layer.queryFeatures(e)):e={features:this.layer.graphics.slice(0)};w(e).then(function(a){(a=a&&a.features)&&a.length?c.resolve(a):d._rejectDfd(c,"FeatureLayerStatistics: layer has 0 features.")}).otherwise(function(a){d._rejectDfd(c,"FeatureLayerStatistics: unable to query features.")});
return c.promise},_calcSizeRange:function(a,b,c,d,e){var f=a&&a.avgSize,g=b.getResolution();b=b.getScale();if(null==f||isNaN(f))this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid average feature size.");else if(!g||!b)this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid map scale/resolution.");else{var h;if(e){var k=g/b;d=this._getScaleValues(d,e);var l=d.feScaleIndex,m=[],p=[];h=d.scales[l];n.forEach(d.scales,function(a,b){var c=this._calcSizeValues(f,k*
a),d=-1<l&&b>l?2:1;m.push({value:a,size:c.min/d});p.push({value:a,size:c.max/d})},this);d={type:"sizeInfo",expression:"view.scale",stops:m};g={type:"sizeInfo",expression:"view.scale",stops:p}}else g=this._calcSizeValues(f,g),d=g.min,g=g.max;c.resolve({minSize:d,maxSize:g,spatialStatistics:a,avgFeatureSize:f,scaleAtFullExtent:h,suggestedScaleRange:e})}},_getScaleValues:function(a,b){var c=this.tileInfo.lods,d=this.layer.minScale||c[0].scale,c=this.layer.maxScale||c[c.length-1].scale,e=b&&b.minScale||
0,f=b&&b.maxScale||0,g=a&&this._findLODForFE(this.tileInfo.lods,a,this.mapWidth,this.mapHeight),g=g&&g.scale<d&&g.scale>c?Math.round(g.scale):0,h=n.map([d,c,e,f,g],Math.round);h.sort(this._numberSorter);h=n.filter(h,function(a,b){return!!a&&n.indexOf(h,a)===b});h=n.filter(h,function(a,b,c){return b?5<Math.abs(a-c[b-1]):!0});return{scales:h,feScaleIndex:n.indexOf(h,g)}},_numberSorter:function(a,b){return a-b},_findLODForFE:function(a,b,c,d){var e=a.length,f=b.getWidth(),g=b.getHeight(),h,k;for(b=0;b<
e;b++)if(h=a[b],c*h.resolution<f||d*h.resolution<g){k=0===b?a[b]:a[b-1];break}else if(b===e-1){k=a[b];break}return k},_calcSizeValues:function(a,b){a=Math.ceil(a/b);var c=Math.ceil(a/4);4>c?c=4:16<c&&(c=16);var d=5*c;return{min:c,max:50>d?50:d}},_getOutline:function(a){var b=this;"esriGeometryPolygon"!==this.layer.geometryType?this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: not supported for points and lines."):this._getFeatures().then(function(c){b.getSpatialStatistics({features:c}).then(function(d){if(d.avgSize){var e;
n.some(c,function(a){a.geometry&&(e=a.geometry.spatialReference);return!!e});b._calcOutline(d,e,a.params,a.dfd)}else b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: average feature size is 0 or null.")}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: unable to calculate spatial statistics.")})}).otherwise(function(c){b._rejectDfd(a.dfd,c.message)})},_calcOutline:function(a,b,c,d){var e=a.avgSize,f=c&&null!=c.allowZeroWidth?c.allowZeroWidth:!0,
g=39.37*96*X.getUnitValueForSR(b);b=n.map(n.filter(this._outlineInfo,function(a,b){return f||0<b}),function(a){return{size:a.width,value:Math.round(e/a.size*g)}});b.sort(function(a,b){return a.value-b.value});d.resolve({widthInfo:{type:"sizeInfo",target:"outline",expression:"view.scale",stops:b},spatialStatistics:a})},_getHeatmapStats:function(a){var b=this,c=this.layer,d=a.params,e=a.dfd,f=d.fieldOffset;a=d.field&&this.layer.getField(d.field);if(!d.field||!this._rejectNonNumeric(e,a,"getHeatmapStatistics"))d.field&&
null==f?c.statisticsPlugin.getFieldStatistics({field:d.field}).then(function(a){b._calcHeatmapStats(a,f,d,e)}).otherwise(function(a){b._rejectDfd(e,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate field statistics.")}):this._calcHeatmapStats(null,f,d,e)},_calcHeatmapStats:function(a,b,c,d){var e=this;if(a){var f=a.min,g=a.max;a.count?f===g&&0===f?b=1:0>=g?b="abs":0>f&&(b=-1.01*f):b=1}this._heatStatsFromMemory(c,b).then(function(c){c.fieldStatistics=a;c.fieldOffset=b;d.resolve(c)}).otherwise(function(a){e._rejectDfd(d,
"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.")})},_heatStatsFromMemory:function(a,b){var c=new q,d=this.layer,e=d.graphics,f=e.length,g=d.getMap();if(!f)return c.resolve({count:0,min:null,max:null,avg:null,stddev:null,source:this._srcMemory}),c.promise;(d=(d=g&&$(ba(e,g,d),g.width,g.height,a.blurRadius||10,a.field,b))&&d.matrix&&aa(d.matrix))?c.resolve({count:f,min:d.min,max:d.max,avg:d.mean,stddev:d.stdDev,source:this._srcMemory}):this._rejectDfd(c,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.");
return c.promise},_getHistogram:function(a){var b=this,c=a.params,d=c.minValue,e=c.maxValue,f=c.valueExpression||c.sqlExpression,g=this._canUseSQL92Expression(),h=null!=d&&null!=e,k=c.field?this.layer.getField(c.field):null,l=k?k.type===this._dateType:!1,m=!c.classificationMethod||"equal-interval"===c.classificationMethod;if(k){if(this._rejectIfInvalidType(a.dfd,k,"getHistogram",[].concat(this._numericTypes).concat(this._dateType)))return;if(l){if(c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when calculating histogram for date field.");
return}if(!m){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram:  classification methods other than 'equal-interval' are not supported when calculating histogram for date field.");return}}}else if(f){if(c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when valueExpression or sqlExpression is specified.");return}if(!m){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: classification methods other than 'equal-interval' are not supported when valueExpression or sqlExpression is specified.");
return}}f&&!this._isCollection()?this._getBinsFromStatsQueryForExpr(a.dfd,c,d,e):g&&m&&!this._isCollection()?this._getBinsFromStatsQueryForField(a,l):c.normalizationType||!m?this._binParamsFromGenRend(c).then(function(f){if(h)if(d>f.max||e<f.min)b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: custom value range is beyond field value range.");else{var g=b._getFieldExpr(c,f.normTotal),g=b._getRangeExpr(g,d,e);m?b._getBins(a,f.sqlExpr,d,e,null,"parameters",null,f.excludeZerosExpr):b._binParamsFromGenRend(c,
g).then(function(c){b._getBins(a,c.sqlExpr,c.min,c.max,c.intervals,c.source,c.normTotal,c.excludeZerosExpr)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate histogram parameters using custom min/max values.")})}else b._getBins(a,f.sqlExpr,f.min,f.max,f.intervals,f.source,f.normTotal,f.excludeZerosExpr)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max from generate renderer operation.")}):
h?this._getBins(a,null,d,e,null,"parameters"):this.getFieldStatistics(c).then(function(c){c.count?b._getBins(a,null,c.min,c.max,null,c.source):b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: cannot calculate histogram for 0 features (statistics.count \x3d 0).")}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})},_getBins:function(a,b,c,d,e,f,g,h){var k=this,l=a.params.field,m=l?this.layer.getField(l):null,m=m?m.type===this._dateType:
!1,p=a.params.numBins||this.numBins;e=e||this._getEqualIntervalBins(c,d,p);b=b||l;!this._isCollection()&&!m?this._queryBins(b,e,h).then(function(b){b=n.map(b,function(a,b){return{minValue:e[b][0],maxValue:e[b][1],count:a}});a.dfd.resolve({bins:b,minValue:c,maxValue:d,normalizationTotal:g,source:k._srcQuery,statisticsSource:f})}).otherwise(function(b){k._countBinsInMemory(a,c,d,e,g,f)}):this._countBinsInMemory(a,c,d,e,g,f)},_getEqualIntervalBins:function(a,b,c){b=(b-a)/c;var d=a,e,f=[];for(a=1;a<=
c;a++)e=d+b,e=Number(e.toFixed(16)),f.push([d,e]),d=e;return f},_countBinsInMemory:function(a,b,c,d,e,f){var g=this;this._binsFromMemory(a.params,b,c,d,e).then(function(d){a.dfd.resolve({bins:d,minValue:b,maxValue:c,normalizationTotal:e,source:g._srcMemory,statisticsSource:f})}).otherwise(function(b){g._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate histogram.")})},_queryBins:function(a,b,c){var d=this.layer,e,f,g=[],h=b.length;for(e=0;e<h;e++)f=new v,f.where=(c?c+" AND ":"")+a+" \x3e\x3d "+
b[e][0]+(null!==b[e][1]?" AND "+a+(e===h-1?" \x3c\x3d ":" \x3c ")+b[e][1]:""),g.push(f);return K(n.map(g,function(a){return d.queryCount(a)}))},_binsFromMemory:function(a,b,c,d,e){var f=new q,g=a.field,h=a.valueExpression,k=a.normalizationType;a=a.normalizationField;var l=this.layer.graphics,m,p,n,y,t,x=[];if(!l.length)return this._rejectDfd(f,"Layer has 0 features in memory."),f.promise;h&&(h=u.parseExpression(h));y=d.length;for(n=0;n<y;n++)x.push({minValue:d[n][0],maxValue:d[n][1],count:0});y=l.length;
for(n=0;n<y;n++)m=l[n],t=null,h?t=u.executeExpression(h,u.createExecContext(m)):(m=(p=m&&m.attributes)&&p[g],null!=m&&(k?(t=null,p=p&&parseFloat(p[a]),"log"===k&&0!=m?t=Math.log(m)*this._log10e:"percent-of-total"===k&&!isNaN(e)&&0!=e?t=100*(m/e):"field"===k&&(!isNaN(p)&&0!=p)&&(t=m/p)):t=m)),null!=t&&(!isNaN(t)&&t>=b&&t<=c)&&(t=this._binIndex(d,t),-1<t&&x[t].count++);f.resolve(x);return f.promise},_binIndex:function(a,b){var c,d,e=-1;for(c=a.length-1;0<=c;c--)if(d=a[c][0],b>=d){e=c;break}return e},
_binParamsFromGenRend:function(a,b){var c=this.layer,d=new q,e=this,f=this._getGRWhereInfo(c,a),g=f.where,h=a.numBins||this.numBins,k=this._createCBDefn(a,h),l=new D;l.classificationDefinition=k;l.where=g?g+(b?" AND "+b:""):b;!this._isCollection()&&10.1<=c.version?this._grTask.execute(l).then(function(b){e._resolveBinParams(b,f,e._srcGenRend,a,d)}).otherwise(function(b){e._binParamsFromMemory(h,f,e._srcMemory,a,d)}):e._binParamsFromMemory(h,f,e._srcMemory,a,d);return d.promise},_binParamsFromMemory:function(a,
b,c,d,e){var f=this;this._cbFromMemory(d,a).then(function(a){f._resolveBinParams(a,b,c,d,e)}).otherwise(function(a){f._rejectDfd(e,"FeatureLayerStatistics.getHistogram: unable to calculate class breaks.")})},_resolveBinParams:function(a,b,c,d,e){var f,g,h=[],k=a.infos;g=k.length;f=k[0].minValue;g=k[g-1].maxValue;n.forEach(k,function(a,b){h.push([a.minValue,a.maxValue])});e.resolve({min:f,max:g,intervals:h,sqlExpr:this._getFieldExpr(d,a.normalizationTotal),excludeZerosExpr:b.excludeZerosExpr,normTotal:a.normalizationTotal,
source:c})},_getGRWhereInfo:function(a,b){var c=b.field,d=b.normalizationType,e=b.normalizationField,f=a.getDefinitionExpression(),g;"log"===d?g="(NOT "+c+" \x3d 0)":"field"===d&&(g="(NOT "+e+" \x3d 0)");return{where:g?g+(f?" AND "+f:""):f,excludeZerosExpr:g}},_getFieldExpr:function(a,b){var c=a.field,d=a.normalizationType,e=a.normalizationField,f=c;"percent-of-total"===d?f="(("+c+" / "+b+") * 100)":"log"===d?f="(log("+c+") * "+this._log10e+")":"field"===d&&(f="("+c+" / "+e+")");return f},_getRangeExpr:function(a,
b,c){b=null!=b?a+" \x3e\x3d "+b:"";a=null!=c?a+" \x3c\x3d "+c:"";c="";return(c=b&&a?b+" AND "+a:b||a)?"("+c+")":""},_getBinsFromStatsQueryForExpr:function(a,b,c,d){var e=this,f=null!=c&&null!=d;c=f?{min:c,max:d}:this.getFieldStatistics(b);w(c).then(function(c){e._getBinsFromStatsQuery(b,c.min,c.max,f?"parameters":c.source).then(function(b){a.resolve(b)}).otherwise(function(b){e._rejectDfd(a,"FeatureLayerStatistics.getHistogram: query to calculate count failed.")})}).otherwise(function(b){e._rejectDfd(a,
"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})},_getBinsFromStatsQueryForField:function(a,b){var c=this,d=a.params,e=this.layer,f;"percent-of-total"===d.normalizationType&&(f=this.getFieldStatistics({field:d.field}).then(function(a){return a.sum}));w(f).then(function(f){f={numBins:d.numBins,sqlExpression:b?c._msSinceUnixEpochSQL(d.field):c._getFieldExpr(d,f),sqlWhere:b?null:c._getGRWhereInfo(e,d).excludeZerosExpr};c._getBinsFromStatsQueryForExpr(a.dfd,f,d.minValue,d.maxValue)}).otherwise(function(b){c._rejectDfd(a.dfd,
"FeatureLayerStatistics.getHistogram: unable to calculate normalizationTotal.")})},_getBinsFromStatsQuery:function(a,b,c,d){var e=this.layer,f=new q;if(this._canUseSQL92Expression()){var g=this._getEqualIntervalBins(b,c,a.numBins||this.numBins),h=this._calcBinsSQL(a.sqlExpression,g),k=this,l=new C;l.statisticType="count";l.outStatisticFieldName="countOFExpr";l.onStatisticField="*";var m=new v;m.outStatistics=[l];m.groupByFieldsForStatistics=[h];m.orderByFields=[h];m.where=a.sqlWhere;m.sqlFormat="standard";
e.queryFeatures(m).then(function(a){var e={};n.forEach(a.features,function(a){var b=a.attributes;a=this._getCustomExprVal(b,"countOFExpr");b=this._getAttributeVal(b,"countOFExpr");0!==a&&(e[a]=b)},k);var h=[];n.forEach(g,function(a,b){var c=b+1;h.push({minValue:a[0],maxValue:a[1],count:e.hasOwnProperty(c)?e[c]:0})});f.resolve({bins:h,minValue:b,maxValue:c,source:k._srcQuery,statisticsSource:d})}).otherwise(function(a){k._rejectDfd(f,"FeatureLayerStatistics.getHistogram: Statistics query operation failed.")})}else this._rejectDfd(f,
"FeatureLayerStatistics.getHistogram: make sure the layer supports advanced SQL expressions and standardized queries.");return f.promise},_sampleFeatures:function(a){var b=this,c=a.params,d=a.dfd,e=this.layer,f=e.graphics;a=this._sampleCache;var g=c&&c.resample,h=c&&c.sampleSize||this.sampleSize;a&&!g?d.resolve(this._cloneSample(a)):(d._time={start:this._getTime()},f.length&&h<=f.length?this._resolveSample(d,this._pickItems(f,h),this._srcMemory):(a=new v,a.where="1\x3d1",d._time.countStart=this._getTime(),
e.queryCount(a).then(function(a){d._time.countEnd=b._getTime();d._totalFeatures=a;h>e.maxRecordCount&&(h=e.maxRecordCount);var g;if(a)if(a<=f.length)b._resolveSample(d,b._pickItems(f,f.length),b._srcMemory);else if(a<=h)g=new v,g.where="1\x3d1",b._queryFeatures(g,c,e,f,d);else if(a<=b.samplingThreshold)a=new v,a.where="1\x3d1",d._time.idStart=b._getTime(),e.queryIds(a).then(function(a){d._time.idEnd=b._getTime();var g=new v;g.objectIds=b._pickItems(a,h);b._queryFeatures(g,c,e,f,d)}).otherwise(function(a){g=
new v;g.where="1\x3d1";b._queryFeatures(g,c,e,f,d)});else{g=new v;g.where="1\x3d1";if((a=e.advancedQueryCapabilities)&&a.supportsPagination)g.num=h;b._queryFeatures(g,c,e,f,d)}else b._resolveSample(d,[],b._srcQuery)}).otherwise(function(a){b._resolveSample(d,b._pickItems(f,f.length),b._srcMemory)})))},_queryFeatures:function(a,b,c,d,e){var f=this;a.outSpatialReference=b&&b.spatialReference;a.maxAllowableOffset=b&&b.maxAllowableOffset;a.outFields=b&&b.outFields;b&&null!=b.returnGeometry&&(a.returnGeometry=
b.returnGeometry);e._time.featStart=this._getTime();c.queryFeatures(a).then(function(a){e._time.featEnd=f._getTime();f._resolveSample(e,a&&a.features||[],f._srcQuery)}).otherwise(function(a){f._resolveSample(e,f._pickItems(d,d.length),f._srcMemory)})},_pickItems:function(a,b){var c=a.length,d=[],e,f=[];if(b>=c)f=a.slice(0);else for(;f.length<b;)e=this._getRandomInt(0,c),-1===n.indexOf(d,e)&&(d.push(e),f.push(a[e]));return f},_getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a))+a},_resolveSample:function(a,
b,c){b=b||[];var d,e=b.length,f;for(d=0;d<e&&!(f=(f=b[d].geometry)&&f.spatialReference);d++);a._time.end=(new Date).getTime();d=a._time;a._time=null;this._sampleCache={features:b,spatialReference:f&&new A(f.toJson()),source:c,time:this._getTimeStats(d),totalFeatures:a._totalFeatures};a.resolve(this._cloneSample(this._sampleCache))},_cloneSample:function(a){return{features:n.map(a.features,function(a){return new a.constructor(a.toJson())}),spatialReference:a.spatialReference&&new A(a.spatialReference.toJson()),
source:a.source,time:r.clone(a.time),totalFeatures:a.totalFeatures}},_getTimeStats:function(a){var b=this._getTimeDiff;return{total:b(a.start,a.end),features:b(a.featStart,a.featEnd),featureIds:b(a.idStart,a.idEnd),featureCount:b(a.countStart,a.countEnd)}},_getTimeDiff:function(a,b){var c,d;null!=a&&null!=b&&(c=b-a,d="millisecond",1E3<=c&&(c/=1E3,d="second",60<=c&&(c/=60,d="minute")),c={value:Number(c.toFixed(2)),unit:d});return c},_getTime:function(){return(new Date).getTime()},_scaleRange:function(a){var b=
this,c=a.params,d=this.layer,e=c&&c.sampleSize||this.sampleSize,f=c&&c.map||d.getMap(),g=c&&c.mapWidth||this.mapWidth,h=c&&c.mapHeight||this.mapHeight,k=c&&c.generalizeForScale||this.generalizeForScale,l,m;c&&!1===c.map&&(f=null);f&&f.__tileInfo?(l=f.__tileInfo,m=f.spatialReference,f=f.extent.getWidth()/f.width/f.getScale()*k):(l=this.tileInfo,m=l.spatialReference,f=this.generalizeForResolution/this.generalizeForScale*k);this.getSampleFeatures({sampleSize:e,spatialReference:m,maxAllowableOffset:f,
outFields:[]}).then(function(e){var f=b._projectExtent(d.fullExtent,m),k=e.features;k&&k.length?b.getSpatialStatistics({features:k}).then(function(d){w(f).always(function(f){f=f&&f.hasOwnProperty("xmin")?f:null;b._processScaleRange(a.dfd,c,l,g,h,f,e,d)})}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to calculate spatial statistics.")}):b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: sampling returned 0 features.")}).otherwise(function(c){b._rejectDfd(a.dfd,
"FeatureLayerStatistics.getSuggestedScaleRange: unable to sample features.")})},_processScaleRange:function(a,b,c,d,e,f,g,h){var k=this.layer.geometryType,l={point:"esriGeometryPoint"===k,mPoint:"esriGeometryMultipoint"===k,line:"esriGeometryPolyline"===k,polygon:"esriGeometryPolygon"===k},k=c.lods,m=this._getLODForMinScale(b,h,l,c),n=l.polygon?this._getLODForMaxScale(b,h,l,c):null,s=1-this.mapPaddingRatioForFE,q=(s=f&&this._findLODForFE(k,f,d*s,e*s))?s.scale:null,t=(b=this._getLODForMinScale(b,h,
l,c,this.minScaleRelaxationRatio))?b.scale:null,r=(b=h.avgXY)&&new Y(b.x,b.y,g.spatialReference&&new A(g.spatialReference.toJson())),v=this,u,w=l.polygon?n?Math.floor(n.scale):null:0,z;m&&(f&&r)&&(z=this._findClosestLOD(k,m,f,r,d,e));u=(m=z||m)?Math.ceil(m.scale):null;t=t&&q?Math.max(t,2*q):t||2*q;q=q&&Math.ceil(q);t=t&&Math.ceil(t);m||n?m&&r?this._countAtView(r,m,d,e).then(function(b){var c;b||(b=g.features[0],c=l.point?b.geometry:(b=b.geometry&&b.geometry.getExtent())&&b.getCenter());v._resolveScaleRange(a,
u,w,q,t,c||r,g,h)}).otherwise(function(b){v._resolveScaleRange(a,u,w,q,t,r,g,h)}):this._resolveScaleRange(a,u,w,q,t,r,g,h):this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: unable to find optimal scale range.")},_resolveScaleRange:function(a,b,c,d,e,f,g,h){b<c?this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: invalid scale range - calculated minScale is less than maxScale."):a.resolve({minScale:b&&(b>this.worldScale?0:b),maxScale:c,scaleAtFullExtent:d,relaxedMinScale:e&&
(e>this.worldScale?0:e),center:f,sampleInfo:g,spatialStatistics:h})},_countAtView:function(a,b,c,d){a=this._getExtentFromCenter(a,b,c,d);b=new v;b.geometry=a;return this.layer.queryCount(b).promise},_projectExtent:function(a,b){if(a.spatialReference.equals(b))return new a.constructor(a.toJson());if(H.canProject(a.spatialReference,b))return H.project(a,b);var c=new U;c.geometries=[a];c.outSR=b;return this._gsTask.project(c).then(function(a){return a&&a[0]})},_getLODForMinScale:function(a,b,c,d,e){var f=
a&&a.minDistance||this.minDistance,g=a&&a.minLength||this.minLength;a=a&&a.minSize||this.minSize;var h,k,l;c.point?(h=b.avgMinDistance,l=f):c.mPoint?(h=b.avgMinDistance,l=f):c.line?(h=b.avgLength,l=g):c.polygon&&(h=b.avgSize,l=a);0<h&&(k=this._findLOD(d,h,l*(e||1)));return k},_getLODForMaxScale:function(a,b,c,d){var e=this.mapWidth,f=a&&a.maxDistance||e/4,g=a&&a.maxLength||e/4;a=a&&a.maxSize||e/2;var h,k,l;c.point?(h=b.minDistance,l=f):c.mPoint?(h=b.minDistance,l=f):c.line?(h=b.minLength,l=g):c.polygon&&
(h=b.minSize,l=a);0<h&&(k=this._findLOD(d,h,null,l));return k},_findLOD:function(a,b,c,d){a=a&&a.lods;var e,f,g,h;if(a&&a.length){var k=null!=d,l=k?0:a.length-1,m=k?-1:1;for(g=k?a.length-1:0;k?g>=l:g<=l;g+=m)if(f=a[g],h=Math.round(b/f.resolution),k){if(h<=d){e=f;break}}else if(h>=c){e=f;break}}return e},_getExtentFromCenter:function(a,b,c,d){c=c/2*b.resolution;b=d/2*b.resolution;return new Z(a.x-c,a.y-b,a.x+c,a.y+b,new A(a.spatialReference.toJson()))},_findClosestLOD:function(a,b,c,d,e,f){var g,h=
a.length,k,l;for(g=0;g<h;g++)if(!(a[g].level<b.level))if(k=this._getExtentFromCenter(d,a[g],e,f),k.contains(c)){if(g===h-1){l=a[g];break}}else{l=a[g-1];break}return l=l&&l.level>b.level?l:null},_findUniqueValues:function(a){var b=this,c=a.params,d=c.field,e=d?this.layer.getField(d):null;d&&!e?this._rejectDfd(a.dfd,"FeatureLayerStatistics.getUniqueValues: unknown 'field'."):this._isCollection()?this._uvFromMemory(c).then(function(c){b._resolveUVDfd(c,a,e,b._srcMemory)}).otherwise(function(c){b._rejectDfd(a.dfd,
"FeatureLayerStatistics: unable to calculate unique values.")}):this._uvFromStatisticsQuery(c).then(function(c){b._resolveUVDfd(c,a,e,b._srcQuery)}).otherwise(function(d){b._uvFromGenRenderer(c,e).then(function(c){b._resolveUVDfd(c,a,e,b._srcGenRend)}).otherwise(function(d){b._uvFromMemory(c).then(function(c){b._resolveUVDfd(c,a,e,b._srcMemory)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate unique values.")})})})},_uvFromStatisticsQuery:function(a){var b=this.layer,
c=new q;if(b.supportsStatistics){var d=a.field;a=a.sqlExpression;var e="countOF"+(d||"Expr"),f=this,g=new C;g.statisticType="count";g.onStatisticField=a?"*":d;g.outStatisticFieldName=e;var h=new v;h.outStatistics=[g];h.groupByFieldsForStatistics=[d||a];h.sqlFormat=a?"standard":null;b.queryFeatures(h).then(function(a){var g,m,p={},q,u;n.forEach(a.features,function(a){g=a.attributes;m=d?this._getAttributeVal(g,d):this._getCustomExprVal(g,e);q=this._getAttributeVal(g,e);null===m&&0===q&&(u=!0);if(null==
m||""===m||"string"===typeof m&&""===r.trim(m))m=null;null==p[m]?p[m]={count:q,data:m}:p[m].count+=q},f);d&&u?(h=new v,h.where=d+" is NULL",b.queryCount(h).then(function(a){p["null"].count+=a||0;c.resolve({count:p})}).otherwise(function(a){c.resolve({count:p})})):c.resolve({count:p})}).otherwise(function(a){f._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return c.promise},
_uvFromGenRenderer:function(a,b){var c=this.layer,d=new q,e=this;if(10.1<=c.version){var f=new Q;f.attributeField=a.field;var g=new D;g.classificationDefinition=f;g.where=c.getDefinitionExpression();this._grTask.execute(g).then(function(a){var c={},f,g=-1<n.indexOf(e._numericTypes,b.type);n.forEach(a.infos,function(a){f=a.value;if(null==f||""===f||"string"===typeof f&&(""===r.trim(f)||"\x3cnull\x3e"===f.toLowerCase()))f=null;null==c[f]?c[f]={count:a.count,data:g&&f?Number(f):f}:c[f].count+=a.count});
d.resolve({count:c})}).otherwise(function(a){e._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_uvFromMemory:function(a){var b=this.layer,c=new q,d=a.field,e=a.valueExpression,f,g,h={};e&&(e=u.parseExpression(e));n.forEach(b.graphics,function(a){g=e?u.executeExpression(e,u.createExecContext(a)):(f=a.attributes)&&f[d];if(null==g||""===
g||"string"===typeof g&&""===r.trim(g))g=null;null==h[g]?h[g]={count:1,data:g}:h[g].count++},this);c.resolve({count:h});return c.promise},_resolveUVDfd:function(a,b,c,d){var e=a.count;c=c&&this.layer.getDomain(c.name);var f;a=[];b.params.includeAllCodedValues&&(c&&"codedValue"===c.type)&&n.forEach(c.codedValues,function(a){a=a.code;e.hasOwnProperty(a)||(e[a]={data:a,count:0})});for(f in e)c=e[f],a.push({value:c.data,count:c.count});b.dfd.resolve({source:d,uniqueValueInfos:a})},_findClassBreaks:function(a){var b=
this,c=a.params,d=c.minValue,e=c.maxValue,f=null!=d||null!=e,g=c.classificationMethod,h="percent-of-total"===c.normalizationType,k=c.numClasses||this.numClasses,l=!1!==c.analyzeData,m=this.layer.getField(c.field);if(!this._rejectNonNumeric(a.dfd,m,"getClassBreaks")){if(f)if(l){if(h&&null==c.normalizationTotal){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when minValue/maxValue are specified.");return}}else{if(null==d||null==e){this._rejectDfd(a.dfd,
"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");return}if(g&&"equal-interval"!==g){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: data analysis can be disabled only for equal-interval classification.");return}if(h&&null==c.normalizationTotal){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when data analysis is disabled.");return}}else if(!l){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");
return}l?this._cbFromGenRend(c,k).then(function(d){b._resolveCBDfd(a.dfd,c,d,b._srcGenRend)}).otherwise(function(d){f?b._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: cannot calculate class breaks in-memory when minValue/maxValue are specified."):b._cbFromMemory(c,k).then(function(d){b._resolveCBDfd(a.dfd,c,d,b._srcMemory)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}):this._cbFromInterpolation(c,k).then(function(d){b._resolveCBDfd(a.dfd,
c,d,b._srcMemory)}).otherwise(function(c){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}},_cbFromGenRend:function(a,b){var c=this.layer,d=new q,e=this;if(c.url&&10.1<=c.version){var f=this._createCBDefn(a,b),c=this._getGRWhereInfo(c,a).where,g=this._getFieldExpr(a,a.normalizationTotal),g=this._getRangeExpr(g,a.minValue,a.maxValue),h=new D;h.classificationDefinition=f;h.where=c?c+(g?" AND "+g:""):g;this._grTask.execute(h).then(function(a){d.resolve(a)}).otherwise(function(a){e._rejectDfd(d,
"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_cbFromMemory:function(a,b){var c=new q,d=this.layer.graphics;if(d.length){var e=this._createCBDefn(a,b),f;if("percent-of-total"===a.normalizationType){f=this._calcStatsFromMemory({field:a.field}).sum;if(null==f)return this._rejectDfd(c,"FeatureLayerStatistics: Invalid normalizationTotal."),c.promise;
a=r.mixin({normalizationTotal:f},a)}c.resolve(S.createClassBreaksRenderer({features:d,definition:e,values:this._getDataValues(d,a)}))}else this._rejectDfd(c,"Layer has 0 features in memory.");return c.promise},_cbFromInterpolation:function(a,b){var c=new q,d=a.minValue,e=a.maxValue;if(d>=e||!b||1>b)this._rejectDfd(c,"FeatureLayerStatistics.getClassBreaks: invalid input parameters: minValue, maxValue or numClasses.");else{var f=[],g,h,k=(e-d)/b;for(g=0;g<b;g++)h=d+g*k,f.push({minValue:h,maxValue:h+
k});f[b-1].maxValue=e;c.resolve({infos:f,normalizationTotal:a.normalizationTotal})}return c.promise},_createCBDefn:function(a,b){var c=a.field,d=a.classificationMethod||this.classificationMethod,e=a.normalizationType,f=a.normalizationField,g=new R;g.classificationField=c;g.breakCount=b;g.classificationMethod=d;g.standardDeviationInterval="standard-deviation"===d?a.standardDeviationInterval||this.standardDeviationInterval:void 0;g.normalizationType=e;g.normalizationField="field"===e?f:void 0;return g},
_resolveCBDfd:function(a,b,c,d){var e=c.infos,f=e[0].minValue,g=e[e.length-1].maxValue,h="standard-deviation"===b.classificationMethod,k=this._reNumber,l,m,p,e=n.map(e,function(a){p=a.label;m={minValue:a.minValue,maxValue:a.maxValue,label:p};h&&p&&(l=p.match(k),l=n.map(l,function(a){return+r.trim(a)}),2===l.length?(m.minStdDev=l[0],m.maxStdDev=l[1],0>l[0]&&0<l[1]&&(m.hasAvg=!0)):1===l.length&&(-1<p.indexOf("\x3c")?(m.minStdDev=null,m.maxStdDev=l[0]):-1<p.indexOf("\x3e")&&(m.minStdDev=l[0],m.maxStdDev=
null)));return m});a.resolve({minValue:f,maxValue:g,classBreakInfos:e,normalizationTotal:c.normalizationTotal,source:d})},_reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,_noDominantCategoryField:"no_dominant_category",_predominantCategories:function(a){var b=a.dfd,c=a.params.fields,d=this;if(this._canUseExpression()){a=this._predominantCategoryArcade(c);var e=this._predominantCategoryNameSQL(c);(this._isCollection()?this._uvFromMemory({valueExpression:a}):this._uvFromStatisticsQuery({sqlExpression:e.expression,
valueExpression:a})).then(function(a){var e=d._isCollection()?d._srcMemory:d._srcQuery;d._resolvePredominantCategories(b,c,a,e)}).otherwise(function(a){d._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: error when counting features in each predominant category.")})}else this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: make sure the layer supports advanced SQL expressions and standardized queries.")},_resolvePredominantCategories:function(a,b,c,d){var e,f=[],g=c.count;
for(e in g)c=g[e],f.push({value:c.data,count:c.count});var h=n.map(f,function(a){return a.value});e=n.filter(b,function(a){return-1===n.indexOf(h,a)});n.forEach(e,function(a){f.push({value:a,count:0})});f.sort(this._predominantFieldSorter(b));n.forEach(f,function(a){a.value===this._noDominantCategoryField&&(a.value=null)},this);a.resolve({predominantCategoryInfos:f,source:d})},_predominantCategoryNameSQL:function(a){return{expression:this._calcMaxFieldSQL(a,{returnFieldName:!0,defaultValue:"'"+this._noDominantCategoryField+
"'"})}},_calcMaxFieldSQL:function(a,b){var c=[],d,e,f,g;b&&(d=b.resultValue,e=b.returnFieldName,f=b.defaultValue,g=b.integerFields);if(e&&f){var h=n.map(a,function(a){return a+" \x3c\x3d 0"});c.push("WHEN "+h.join(" AND ")+" THEN "+f)}n.forEach(a,function(b){var f=[];n.forEach(a,function(a){b!==a&&f.push(b+" \x3e "+a)});c.push("WHEN "+f.join(" AND ")+" THEN "+(d||e&&"'"+b+"'"||(-1<n.indexOf(g,b)?"cast("+b+" as float)":b)))});return["CASE",c.join(" "),"ELSE "+(f||"0"),"END"].join(" ")},_predominantFieldSorter:function(a){return function(b,
c){var d=n.indexOf(a,b.value),e=n.indexOf(a,c.value);return d-e}},_predominanceExpressions:function(a){var b=a.params.fields,c=n.map(n.filter(this.layer.fields,function(a){return-1<n.indexOf(this._integerTypes,a.type)},this),function(a){return a.name}),d=this._sumOfFieldsSQL(b),c=this._strengthOfPredominanceSQL(b,c);a.dfd.resolve({predominantCategory:{valueExpression:this._predominantCategoryArcade(b)},size:{valueExpression:this._sumOfFieldsArcade(b),statisticsQuery:d,histogramQuery:d},opacity:{valueExpression:this._strengthOfPredominanceArcade(b),
statisticsQuery:c,histogramQuery:c}})},_calcMaxFieldInfo:function(a,b){a=n.map(a,function(a){return'"'+a+'"'});var c=["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var maxValueField \x3d null;","var maxValue \x3d -Infinity;","var value, i, totalValue \x3d null;","for(i \x3d 0; i \x3c numFields; i++) {","value \x3d $feature[fieldNames[i]];","if(value \x3e 0) {","if(value \x3e maxValue) {","maxValue \x3d value;","maxValueField \x3d fieldNames[i];","}","else if (value \x3d\x3d maxValue) {",
"maxValueField \x3d null;","}","}"];b&&c.push("if(value !\x3d null \x26\x26 value \x3e\x3d 0) {","if (totalValue \x3d\x3d null) { totalValue \x3d 0; }","totalValue \x3d totalValue + value;","}");c.push("}");return c},_predominantCategoryArcade:function(a){a=this._calcMaxFieldInfo(a);a.push("return maxValueField;");return a.join("\n")},_sumOfFieldsArcade:function(a){a=n.map(a,function(a){return'"'+a+'"'});return["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var value, i, totalValue \x3d null;\nfor(i \x3d 0; i \x3c numFields; i++) {\nvalue \x3d $feature[fieldNames[i]];\nif(value !\x3d null \x26\x26 value \x3e\x3d 0) {\nif (totalValue \x3d\x3d null) { totalValue \x3d 0; }\ntotalValue \x3d totalValue + value;\n}\n}\nreturn totalValue;"].join("\n")},
_strengthOfPredominanceArcade:function(a){a=this._calcMaxFieldInfo(a,!0);a.push("var strength \x3d null;","if (maxValueField !\x3d null \x26\x26 totalValue \x3e 0) {","strength \x3d (maxValue / totalValue) * 100;","}","return strength;");return a.join("\n")},_calcSumOfFieldsSQL:function(a){return a.join(" + ")},_ensurePositiveFields:function(a){return"("+n.map(a,function(a){return a+" \x3e\x3d 0"}).join(" OR ")+")"},_sumOfFieldsSQL:function(a){return{sqlExpression:"("+this._calcSumOfFieldsSQL(a)+
")",sqlWhere:this._ensurePositiveFields(a)}},_strengthOfPredominanceSQL:function(a,b){return{sqlExpression:"((("+this._calcMaxFieldSQL(a,{integerFields:b})+") / ("+this._calcSumOfFieldsSQL(a)+")) * 100)",sqlWhere:this._ensurePositiveFields(a)+" AND (("+this._calcSumOfFieldsSQL(a)+") \x3e 0)"}},_calcBinsSQL:function(a,b){var c=[],d=b.length;n.forEach(b,function(b,f){c.push("WHEN ("+[a+" \x3e\x3d "+b[0],a+(f===d-1?" \x3c\x3d ":" \x3c ")+b[1]].join(" AND ")+") THEN "+(f+1))});return["CASE",c.join(" "),
"ELSE 0 END"].join(" ")},_ageStatistics:function(a){var b=a.params.units,c=this;this.getAgeExpressions({startTime:a.params.startTime,endTime:a.params.endTime,units:b}).then(function(d){var e={valueExpression:d.valueExpression};r.mixin(e,d.statisticsQuery);c.getFieldStatistics(e).then(function(c){a.dfd.resolve({units:b,statistics:c})}).otherwise(function(b){c._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to calculate statistics.")})}).otherwise(function(b){c._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to generate expressions to calculate age.")})},
_supportedAgeUnits:"years months days hours minutes seconds".split(" "),_unitValueInDays:{years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864E5},_suggestedAgeUnits:function(a){var b=a.params.startTime,c=a.params.endTime,d=this;this._rejectIfInvalidDates(a.dfd,b,c,"getSuggestedAgeUnits")||this.getAgeStatistics({startTime:b,endTime:c,units:"days"}).then(function(b){b=b.statistics;null!=b.avg?a.dfd.resolve({units:d._calcSuggestedAgeUnits(b),statistics:b}):d._rejectDfd(a.dfd,
"FeatureLayerStatistics.getSuggestedAgeUnits: 'avg' statistic is not available.")}).otherwise(function(b){d._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedAgeUnits: unable to calculate statistics.")})},_calcSuggestedAgeUnits:function(a){var b,c=this._unitValueInDays,d=Math.abs(a.avg);n.some(this._supportedAgeUnits,function(a){d>2*c[a]&&(b=a);return!!b});return b},_ageExpressions:function(a){var b=a.params.startTime,c=a.params.endTime,d=a.params.units||"days";if(!this._rejectIfInvalidDates(a.dfd,
b,c,"getAgeExpressions"))if(-1===n.indexOf(this._supportedAgeUnits,d))this._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeExpressions: invalid 'units'. Supported units are: years, months, days, hours, minutes, seconds.");else{var e=this._getDateDiffSQL(b,c,d);a.dfd.resolve({valueExpression:this._getDateDiffArcade(b,c,d),statisticsQuery:e,histogramQuery:e})}},_getDateDiffArcade:function(a,b,c){return[this._readDateValueArcade(a,this._getDateType(a),"startTime"),this._readDateValueArcade(b,this._getDateType(b),
"endTime"),"var retVal \x3d null;\nif (startTime !\x3d null \x26\x26 endTime !\x3d null) {\nstartTime \x3d Date(startTime);\nendTime \x3d Date(endTime);","retVal \x3d DateDiff(endTime, startTime, '"+c+"');","}\nreturn retVal;"].join("\n")},_readDateValueArcade:function(a,b,c){a="number"===b?a:"date"===b?a.getTime():"$feature."+a;return"var "+c+" \x3d "+a+";"},_getDateDiffSQL:function(a,b,c){a="("+this._getDateValueSQL(b,this._getDateType(b))+" - "+this._getDateValueSQL(a,this._getDateType(a))+")";
c=this._unitValueInDays[c];b="/";1>c&&(c=1/c,b="*");return{sqlExpression:1===c?a:"("+a+" "+b+" "+c+")",sqlWhere:null}},_getDateValueSQL:function(a,b){var c;"date"===b||"number"===b?("number"===b&&(a=new Date(a)),c="TIMESTAMP'"+a.getUTCFullYear()+"-"+this._padZeros(a.getUTCMonth()+1)+"-"+this._padZeros(a.getUTCDate())+" "+this._padZeros(a.getUTCHours())+":"+this._padZeros(a.getUTCMinutes())+":"+this._padZeros(a.getUTCSeconds())+"'"):c=a;return c},_padZeros:function(a){return L.pad(a,2,"0")},_getDateType:function(a){var b;
if(a instanceof Date)b="date";else if("number"===typeof a)b="number";else if("string"===typeof a){var c=this.layer.getField(a);"\x3cnow\x3e"===a.toLowerCase()?b="":c&&c.type===this._dateType&&(b="field")}return b},_rejectIfInvalidDates:function(a,b,c,d){var e=[],f=!1,g=n.every([b,c],function(a){(a=this._getDateType(a))&&e.push(a);return!!a},this),h="FeatureLayerStatistics."+d+": invalid combination of 'startTime' and 'endTime' parameters.",k=["date","number"];g?e[0]===e[1]?"field"===e[0]?b===c&&(this._rejectDfd(a,
"FeatureLayerStatistics."+d+": 'startTime' and 'endTime' parameters cannot be identical."),f=!0):(this._rejectDfd(a,h),f=!0):-1<n.indexOf(k,e[0])&&-1<n.indexOf(k,e[1])&&(this._rejectDfd(a,h),f=!0):(this._rejectDfd(a,"FeatureLayerStatistics."+d+": 'startTime' and 'endTime' parameters must be one of these values: a date object, unix epoch time, name of a valid date field or \x26lt;now\x26gt;."),f=!0);return f},_rejectDfd:function(a,b){a.reject(Error(b))},_rejectNonNumeric:function(a,b,c){var d;if(b){if(b.name===
this.layer.objectIdField||-1===n.indexOf(this._numericTypes,b.type))this._rejectDfd(a,"FeatureLayerStatistics."+c+": 'field' should be numeric."),d=!0}else this._rejectDfd(a,"FeatureLayerStatistics."+c+": unknown 'field'."),d=!0;return d},_rejectIfInvalidType:function(a,b,c,d){var e;if(b){if(b.name===this.layer.objectIdField||-1===n.indexOf(d,b.type))this._rejectDfd(a,"FeatureLayerStatistics."+c+": 'field' should be one of these types: "+d.join(",")),e=!0}else this._rejectDfd(a,"FeatureLayerStatistics."+
c+": unknown 'field'."),e=!0;return e},_canUseExpression:function(){return this._isCollection()||this._canUseSQL92Expression()},_canUseSQL92Expression:function(){return this._reHostedFS.test(this.layer.url)},_getAttributeVal:function(a,b){var c,d;b=b.toLowerCase();if(a)for(d in a)if(d.toLowerCase()===b){c=a[d];break}return c},_getCustomExprVal:function(a,b){var c,d;b=b.toLowerCase();if(a)for(d in a)if(d.toLowerCase()!==b){c=a[d];break}return c},_callAfterLoad:function(a,b){if(this._loaded)a.call(this,
b);else F.once(this,"_load",r.hitch(this,a,b))},_numericTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_integerTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],_dateType:"esriFieldTypeDate",_createGRTask:function(){this._grTask=new P(this.layer,{source:this.layer.source,gdbVersion:this.layer.gdbVersion});this._loaded=!0;this.emit("_load")}});r.mixin(z,{add:function(a,b){if(!a.statisticsPlugin){var c=b||{};c.layer=a;a.statisticsPlugin=
new z(c)}},remove:function(a){a.statisticsPlugin&&(a.statisticsPlugin.destroy(),delete a.statisticsPlugin)}});J("extend-esri")&&r.setObject("plugins.FeatureLayerStatistics",z,M);return z});